<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Circle Bouncer: Frenzy Mode</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            overflow: hidden;
        }
        canvas {
            background-color: #1a202c;
            display: block;
            transition: box-shadow 0.5s ease;
        }
        .frenzy-active {
            box-shadow: 0 0 40px rgba(255, 165, 0, 0.8), inset 0 0 20px rgba(255, 100, 0, 0.5) !important;
        }
        .btn-glow {
            transition: all 0.3s ease;
            position: relative;
        }
        .btn-glow:not(:disabled) {
             box-shadow: 0 0 5px rgba(0, 255, 255, 0.5);
        }
        .btn-glow:hover:not(:disabled) {
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.8), 0 0 25px rgba(0, 255, 255, 0.5);
            transform: translateY(-2px);
        }
        .btn-glow:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: translateY(0);
            box-shadow: none;
        }
        .tooltip-icon {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 16px;
            height: 16px;
            background-color: rgba(0,0,0,0.3);
            color: white;
            border-radius: 50%;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: help;
            z-index: 10;
        }
        .tooltip-text {
            visibility: hidden;
            width: 160px;
            background-color: #2d3748;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 20;
            bottom: 125%;
            left: 50%;
            margin-left: -80px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            font-weight: normal;
        }
        .tooltip-icon:hover + .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        .spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            width: 16px;
            height: 16px;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center h-screen p-4">

    <!-- Main Game Container -->
    <div id="game-container" class="w-full max-w-md md:max-w-lg lg:max-w-xl aspect-square mb-4">
        <canvas id="gameCanvas"></canvas>
    </div>
    
    <!-- UI Controls -->
    <div class="w-full max-w-md md:max-w-lg lg:max-w-xl text-center">
        <!-- Stats Display -->
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 mb-4">
            <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-2 border border-gray-700">
                <h2 class="text-xs sm:text-sm font-bold text-cyan-300 tracking-wider">WALLET</h2>
                <p class="text-xl sm:text-2xl font-mono font-bold wallet-glow" id="wallet">$<span id="wallet-amount">0</span></p>
            </div>
            <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-2 border border-gray-700">
                <h2 class="text-xs sm:text-sm font-bold text-violet-300 tracking-wider">LEVEL</h2>
                <p class="text-xl sm:text-2xl font-mono font-bold" id="level-display">1</p>
            </div>
             <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-2 border border-gray-700">
                <h2 class="text-xs sm:text-sm font-bold text-green-300 tracking-wider">BALLS</h2>
                <p class="text-xl sm:text-2xl font-mono font-bold" id="ball-count">0</p>
            </div>
            <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-2 border border-gray-700">
                <h2 class="text-xs sm:text-sm font-bold text-red-300 tracking-wider">SPEED</h2>
                <p class="text-xl sm:text-2xl font-mono font-bold" id="speed-display">1.0x</p>
            </div>
        </div>
        <div id="level-goal-container" class="mb-4 text-violet-200">Goal: $<span id="level-goal">100</span></div>


        <!-- Action Buttons -->
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-4">
            <button id="addBallBtn" class="btn-glow bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-4 rounded-lg">
                <div class="tooltip-icon">? <span class="tooltip-text">Adds a new ball. More balls mean more chances to earn money.</span></div>
                <div>Add Ball</div>
                <div class="text-sm opacity-90" id="addBallCostText">Cost: $10</div>
            </button>
            <button id="increaseSpeedBtn" class="btn-glow bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-4 rounded-lg">
                 <div class="tooltip-icon">? <span class="tooltip-text">Increases the speed of all balls. Faster balls earn money quicker.</span></div>
                <div>Speed Up</div>
                <div class="text-sm opacity-90" id="increaseSpeedCostText">Cost: $50</div>
            </button>
            <button id="powerUpBtn" class="btn-glow bg-amber-600 hover:bg-amber-500 text-white font-bold py-3 px-4 rounded-lg">
                 <div class="tooltip-icon">? <span class="tooltip-text">Queues a special power-up for the next ball you create.</span></div>
                <div>Power-up</div>
                <div class="text-sm opacity-90" id="powerUpCostText">Cost: $75</div>
            </button>
            <button id="frenzyBtn" class="btn-glow bg-rose-700 hover:bg-rose-600 text-white font-bold py-3 px-4 rounded-lg">
                 <div class="tooltip-icon">? <span class="tooltip-text">Starts a 10s frenzy! All earnings are multiplied by 5x.</span></div>
                <div>Frenzy</div>
                <div class="text-sm opacity-90" id="frenzyCostText">Cost: $250</div>
            </button>
        </div>
         <!-- Gemini API Button -->
        <div class="w-full">
             <button id="getAdviceBtn" class="btn-glow bg-purple-700 hover:bg-purple-600 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2">
                <span id="adviceBtnText">✨ Get Advice</span>
                <div id="adviceSpinner" class="spinner hidden"></div>
            </button>
        </div>
        
        <!-- Message Display -->
        <div id="message-box" class="mt-4 h-12 text-yellow-400 font-semibold transition-opacity duration-500 opacity-0 flex items-center justify-center text-center"></div>
    </div>

    <script>
        // --- DOM Elements ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gameContainer = document.getElementById('game-container');
        const walletAmountEl = document.getElementById('wallet-amount');
        const levelDisplayEl = document.getElementById('level-display');
        const levelGoalEl = document.getElementById('level-goal');
        const ballCountEl = document.getElementById('ball-count');
        const speedDisplayEl = document.getElementById('speed-display');
        const addBallBtn = document.getElementById('addBallBtn');
        const increaseSpeedBtn = document.getElementById('increaseSpeedBtn');
        const powerUpBtn = document.getElementById('powerUpBtn');
        const frenzyBtn = document.getElementById('frenzyBtn');
        const addBallCostText = document.getElementById('addBallCostText');
        const increaseSpeedCostText = document.getElementById('increaseSpeedCostText');
        const powerUpCostText = document.getElementById('powerUpCostText');
        const frenzyCostText = document.getElementById('frenzyCostText');
        const getAdviceBtn = document.getElementById('getAdviceBtn');
        const adviceBtnText = document.getElementById('adviceBtnText');
        const adviceSpinner = document.getElementById('adviceSpinner');
        const messageBox = document.getElementById('message-box');

        // --- Game State ---
        let wallet = 50, balls = [], speedMultiplier = 1.0, addBallCost = 5;
        let increaseSpeedCost = 10, powerUpCost = 35, frenzyCost = 125;
        let level = 1, levelGoal = 100;
        const shapes = ['circle', 'square', 'triangle', 'hexagon'];
        let currentShape = 'circle';
        let nextPowerUp = 'none';
        let isFrenzyActive = false, frenzyTimer = 0;
        
        // --- Sound Synthesis ---
        const synth = new Tone.MembraneSynth({ octaves: 4, pitchDecay: 0.01, envelope: { attack: 0.001, decay: 0.2, sustain: 0 } }).toDestination();
        const levelUpSynth = new Tone.PolySynth(Tone.Synth).toDestination();
        const frenzySynth = new Tone.FMSynth({ modulationIndex: 10, harmonicity: 3, envelope: { attack: 0.01, decay: 0.2 } }).toDestination();

        // --- Game Setup ---
        let container = { x: 0, y: 0, size: 0, vertices: [] };

        function resizeCanvas() {
            const size = Math.min(gameContainer.clientWidth, gameContainer.clientHeight);
            canvas.width = size;
            canvas.height = size;
            container.x = canvas.width / 2;
            container.y = canvas.height / 2;
            container.size = canvas.width;
            updateContainerVertices();
        }

        // --- Ball Class ---
        class Ball {
            constructor() {
                this.radius = 8;
                this.x = container.x;
                this.y = container.y;
                const angle = Math.random() * 2 * Math.PI;
                const speed = (2 + Math.random()) * speedMultiplier;
                this.dx = Math.cos(angle) * speed;
                this.dy = Math.sin(angle) * speed;
                this.power = nextPowerUp;
                nextPowerUp = 'none';
                this.color = this.getPowerUpColor();
            }
            
            getPowerUpColor() {
                if (isFrenzyActive) return `hsl(${Math.random() * 60}, 100%, 50%)`; // Orange/Yellow tones for frenzy
                switch(this.power) {
                    case 'money': return '#FFD700';
                    case 'ghost': return '#E0E0E0';
                    default: return `hsl(${Math.random() * 360}, 90%, 65%)`;
                }
            }

            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = this.getPowerUpColor();
                ctx.globalAlpha = (this.power === 'ghost') ? 0.6 : 1.0;
                ctx.fill();
                ctx.globalAlpha = 1.0;
                ctx.closePath();
            }

            update() {
                this.x += this.dx;
                this.y += this.dy;
                this.handleCollision();
            }
            
            handleCollision() {
                let collided = false;
                if (currentShape === 'circle') {
                    const dist = Math.hypot(this.x - container.x, this.y - container.y);
                    if (dist + this.radius > container.size / 2) {
                        collided = true;
                        const nx = (this.x - container.x) / dist;
                        const ny = (this.y - container.y) / dist;
                        const dot = this.dx * nx + this.dy * ny;
                        this.dx -= 2 * dot * nx;
                        this.dy -= 2 * dot * ny;
                        const overlap = dist + this.radius - (container.size / 2);
                        this.x -= overlap * nx;
                        this.y -= overlap * ny;
                    }
                } else { // Polygon shapes (square, triangle, hexagon)
                    for (let i = 0; i < container.vertices.length; i++) {
                        const p1 = container.vertices[i];
                        const p2 = container.vertices[(i + 1) % container.vertices.length];
                        const dist = this.distToSegment(p1, p2);

                        if (dist < this.radius) {
                            collided = true;
                            const edgeX = p2.x - p1.x;
                            const edgeY = p2.y - p1.y;
                            const edgeLen = Math.hypot(edgeX, edgeY);
                            const nx = -edgeY / edgeLen; // Perpendicular normal
                            const ny = edgeX / edgeLen;
                            const dot = this.dx * nx + this.dy * ny;
                            this.dx -= 2 * dot * nx;
                            this.dy -= 2 * dot * ny;
                            this.x += nx * (this.radius - dist);
                            this.y += ny * (this.radius - dist);
                            break; // Only handle one collision per frame
                        }
                    }
                }

                if (collided) {
                    if (this.power === 'ghost' && Math.random() < 0.25) return;
                    
                    try { Tone.start(); synth.triggerAttackRelease("C2", "8n"); } catch (e) {}
                    
                    let earnings = Math.ceil(speedMultiplier);
                    if (this.power === 'money') earnings *= 2;
                    if (isFrenzyActive) earnings *= 5;
                    
                    wallet += earnings;
                    checkLevelUp();
                    updateUI();
                }
            }

            distToSegment(p1, p2) {
                const l2 = (p2.x - p1.x)**2 + (p2.y - p1.y)**2;
                if (l2 == 0) return Math.hypot(this.x - p1.x, this.y - p1.y);
                let t = ((this.x - p1.x) * (p2.x - p1.x) + (this.y - p1.y) * (p2.y - p1.y)) / l2;
                t = Math.max(0, Math.min(1, t));
                const projX = p1.x + t * (p2.x - p1.x);
                const projY = p1.y + t * (p2.y - p1.y);
                return Math.hypot(this.x - projX, this.y - projY);
            }
            
            updateSpeed() {
                const currentSpeed = Math.hypot(this.dx, this.dy);
                const speedRatio = (currentSpeed / (speedMultiplier / 1.2));
                const newBaseSpeed = speedRatio * speedMultiplier;
                const angle = Math.atan2(this.dy, this.dx);
                this.dx = Math.cos(angle) * newBaseSpeed;
                this.dy = Math.sin(angle) * newBaseSpeed;
            }
        }

        // --- UI & Game Logic ---
        function updateUI() {
            walletAmountEl.textContent = wallet;
            levelDisplayEl.textContent = level;
            levelGoalEl.textContent = levelGoal;
            ballCountEl.textContent = balls.length;
            speedDisplayEl.textContent = `${speedMultiplier.toFixed(1)}x`;
            
            addBallCostText.textContent = `Cost: $${addBallCost}`;
            increaseSpeedCostText.textContent = `Cost: $${increaseSpeedCost}`;
            powerUpCostText.textContent = `Cost: $${powerUpCost}`;
            frenzyCostText.textContent = `Cost: $${frenzyCost}`;
            
            addBallBtn.disabled = wallet < addBallCost;
            increaseSpeedBtn.disabled = wallet < increaseSpeedCost;
            powerUpBtn.disabled = wallet < powerUpCost;
            frenzyBtn.disabled = wallet < frenzyCost || isFrenzyActive;
            
            if (isFrenzyActive) {
                frenzyBtn.querySelector('div:first-child').textContent = `${frenzyTimer}s`;
            } else {
                frenzyBtn.querySelector('div:first-child').textContent = 'Frenzy';
            }

            if (nextPowerUp !== 'none') {
                powerUpBtn.classList.add('ring-2', 'ring-amber-400');
                powerUpBtn.querySelector('div:first-child').textContent = `${nextPowerUp.charAt(0).toUpperCase() + nextPowerUp.slice(1)}`;
            } else {
                powerUpBtn.classList.remove('ring-2', 'ring-amber-400');
                powerUpBtn.querySelector('div:first-child').textContent = 'Power-up';
            }
        }

        function checkLevelUp() {
            if (wallet >= levelGoal) {
                level++;
                levelGoal = Math.ceil(levelGoal * 2.0);
                currentShape = shapes[(level - 1) % shapes.length];
                updateContainerVertices();
                try { levelUpSynth.triggerAttackRelease(["C4", "E4", "G4"], "8n", Tone.now()); } catch(e) {}
                showMessage(`Level Up! Welcome to the ${currentShape.toUpperCase()}!`, 4000);
                updateUI();
            }
        }

        function showMessage(msg, duration = 6000) {
            messageBox.innerHTML = msg;
            messageBox.classList.remove('opacity-0');
            setTimeout(() => { messageBox.classList.add('opacity-0'); }, duration);
        }

        // --- Event Handlers ---
        addBallBtn.addEventListener('click', () => { if (wallet >= addBallCost) { wallet -= addBallCost; balls.push(new Ball()); addBallCost = Math.ceil(addBallCost * 1.4); updateUI(); } });
        increaseSpeedBtn.addEventListener('click', () => { if (wallet >= increaseSpeedCost) { wallet -= increaseSpeedCost; speedMultiplier *= 1.1; balls.forEach(b => b.updateSpeed()); increaseSpeedCost = Math.ceil(increaseSpeedCost * 1.8); updateUI(); } });
        powerUpBtn.addEventListener('click', () => { if (wallet >= powerUpCost) { wallet -= powerUpCost; const p = ['money', 'ghost']; nextPowerUp = p[(p.indexOf(nextPowerUp) + 1) % p.length]; powerUpCost = Math.ceil(powerUpCost * 1.5); showMessage(`Next ball is a <em>${nextPowerUp} ball</em>!`); updateUI(); } });
        frenzyBtn.addEventListener('click', () => { if (wallet >= frenzyCost && !isFrenzyActive) { wallet -= frenzyCost; isFrenzyActive = true; frenzyTimer = 10; try { frenzySynth.triggerAttackRelease("C5", "4n"); } catch(e){} showMessage("FRENZY MODE!", 2000); const interval = setInterval(() => { frenzyTimer--; if (frenzyTimer <= 0) { clearInterval(interval); isFrenzyActive = false; frenzyCost = Math.ceil(frenzyCost * 2); showMessage("Frenzy Over!", 2000); } updateUI(); }, 1000); updateUI(); } });
        getAdviceBtn.addEventListener('click', () => getAdvice());
        window.addEventListener('resize', resizeCanvas);
        
        // --- Gemini API Integration ---
        async function getAdvice() {
            adviceBtnText.textContent = 'Thinking...';
            adviceSpinner.classList.remove('hidden');
            getAdviceBtn.disabled = true;
            const prompt = `You are a strategic advisor for an idle game. A player needs your advice.
            Current Status:
            - Level: ${level} (Shape: ${currentShape})
            - Wallet: $${wallet} / Goal: $${levelGoal}
            - Balls: ${balls.length} at ${speedMultiplier.toFixed(1)}x speed.
            - Costs: Ball($${addBallCost}), Speed($${increaseSpeedCost}), PowerUp($${powerUpCost}), Frenzy($${frenzyCost})
            - Next power-up: ${nextPowerUp}
            Based on this, what is the single best action to take right now? Be concise, encouraging, and slightly quirky.`;
            try {
                const advice = await callGemini(prompt);
                showMessage(`<em>Advisor says:</em> "${advice}"`, 5000);
            } catch (error) {
                showMessage("The advisor is on a coffee break.");
            } finally {
                adviceBtnText.textContent = '✨ Get Advice';
                adviceSpinner.classList.add('hidden');
                getAdviceBtn.disabled = false;
            }
        }
        
        async function callGemini(prompt) { /* ... existing Gemini call logic ... */ 
            const apiKey = ""; // Handled by environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`API request failed`);
            const result = await response.json();
            return result.candidates?.[0]?.content?.parts?.[0]?.text;
        }

        // --- Game Loop & Drawing ---
        function updateContainerVertices() {
            container.vertices = [];
            const s = container.size;
            const pad = 4; // Padding from edge
            if (currentShape === 'square') {
                container.vertices.push({x: pad, y: pad}, {x: s - pad, y: pad}, {x: s - pad, y: s - pad}, {x: pad, y: s - pad});
            } else if (currentShape === 'triangle') {
                container.vertices.push({x: s / 2, y: pad}, {x: s - pad, y: s - pad}, {x: pad, y: s - pad});
            } else if (currentShape === 'hexagon') {
                for (let i = 0; i < 6; i++) {
                    const angle = Math.PI / 3 * i;
                    container.vertices.push({
                        x: s / 2 + (s / 2 - pad) * Math.cos(angle),
                        y: s / 2 + (s / 2 - pad) * Math.sin(angle)
                    });
                }
            }
        }

        function drawContainer() {
            ctx.strokeStyle = '#4a5568';
            ctx.lineWidth = 4;
            ctx.beginPath();
            if (currentShape === 'circle') {
                ctx.arc(container.x, container.y, container.size / 2 - 2, 0, Math.PI * 2);
                canvas.style.borderRadius = '50%';
            } else {
                const v = container.vertices;
                ctx.moveTo(v[0].x, v[0].y);
                for (let i = 1; i < v.length; i++) {
                    ctx.lineTo(v[i].x, v[i].y);
                }
                ctx.closePath();
                canvas.style.borderRadius = '16px';
            }
            ctx.stroke();
        }

        function animate() {
            ctx.fillStyle = isFrenzyActive ? 'rgba(133, 50, 20, 0.25)' : 'rgba(26, 32, 44, 0.25)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            drawContainer();
            
            balls.forEach(ball => { ball.update(); ball.draw(); });
            
            canvas.classList.toggle('frenzy-active', isFrenzyActive);

            requestAnimationFrame(animate);
        }

        // --- Initialization ---
        function init() {
            resizeCanvas();
            balls.push(new Ball());
            updateUI();
            animate();
        }

        init();
    </script>
</body>
</html>
