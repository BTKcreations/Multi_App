<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Resizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom file upload button styling */
        .custom-file-upload {
            border: 2px dashed #cbd5e1;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .custom-file-upload:hover {
            background-color: #f8fafc;
            border-color: #6366f1;
        }
        /* Hide the default file input */
        input[type="file"] {
            display: none;
        }

        /* Keyframe animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes slideUpFadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Animation utility classes */
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        .animate-slide-up {
            animation: slideUpFadeIn 0.5s ease-out forwards;
        }
        
        /* Custom modal for alerts */
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex items-center justify-center min-h-screen p-4">

    <!-- Main Application Container -->
    <div class="w-full max-w-4xl bg-white rounded-xl shadow-lg p-4 sm:p-6 md:p-8 animate-fade-in">
        <div class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Image Resizer</h1>
            <p class="text-slate-500 mt-2">Upload an image, set your dimensions, and download.</p>
        </div>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            
            <!-- Left Column: Upload and Controls -->
            <div class="flex flex-col space-y-6">
                <!-- File Upload Area -->
                <div>
                    <label for="file-upload" id="file-upload-label" class="group custom-file-upload flex flex-col items-center justify-center p-6 rounded-lg cursor-pointer">
                        <svg class="mx-auto h-12 w-12 text-slate-400 transition-transform duration-300 group-hover:scale-110" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        <span class="mt-2 block text-sm font-semibold text-slate-700">Click to upload an image</span>
                        <span class="mt-1 block text-xs text-slate-500">PNG, JPG, GIF up to 10MB</span>
                    </label>
                    <input id="file-upload" name="file-upload" type="file" accept="image/*">
                </div>

                <!-- Resize Controls -->
                <div id="controls" class="hidden space-y-4 bg-slate-50 p-4 rounded-lg border border-slate-200">
                    <h3 class="font-semibold text-lg text-slate-800 border-b pb-2">Resize Options</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="width-input" class="block text-sm font-medium text-slate-700">Width (px)</label>
                            <input type="number" id="width-input" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" inputmode="numeric" pattern="[0-9]*">
                        </div>
                        <div>
                            <label for="height-input" class="block text-sm font-medium text-slate-700">Height (px)</label>
                            <input type="number" id="height-input" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" inputmode="numeric" pattern="[0-9]*">
                        </div>
                    </div>
                    <div class="flex items-center">
                        <input id="aspect-ratio-checkbox" type="checkbox" checked class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
                        <label for="aspect-ratio-checkbox" class="ml-2 block text-sm text-slate-700">Maintain aspect ratio</label>
                    </div>

                    <!-- Basic controls that remain visible on all screen sizes -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="scale-slider" class="block text-sm font-medium text-slate-700">Scale (%) <span id="scale-value" class="text-xs text-slate-500">100%</span></label>
                            <input id="scale-slider" type="range" min="10" max="300" step="1" value="100" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700">Presets</label>
                            <div id="preset-buttons" class="mt-1 flex flex-wrap gap-2">
                                <button type="button" data-size="256" class="px-2 py-1 text-xs rounded bg-slate-200 hover:bg-slate-300">256</button>
                                <button type="button" data-size="512" class="px-2 py-1 text-xs rounded bg-slate-200 hover:bg-slate-300">512</button>
                                <button type="button" data-size="1024" class="px-2 py-1 text-xs rounded bg-slate-200 hover:bg-slate-300">1024</button>
                                <button type="button" data-size="2048" class="px-2 py-1 text-xs rounded bg-slate-200 hover:bg-slate-300">2048</button>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced controls collapsed on mobile -->
                    <details id="advanced-controls" class="rounded border border-slate-200 bg-white p-3">
                        <summary class="cursor-pointer text-sm font-medium text-slate-700 select-none">Advanced options</summary>
                        <div class="mt-3 space-y-4">
                            <div>
                                <label for="format-select" class="block text-sm font-medium text-slate-700">Output Format</label>
                                <select id="format-select" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                    <option>PNG</option>
                                    <option>JPEG</option>
                                    <option>WEBP</option>
                                </select>
                            </div>
                            <div id="quality-control" class="hidden">
                                <label for="quality-slider" class="block text-sm font-medium text-slate-700">Quality (<span id="quality-value">0.92</span>)</label>
                                <input id="quality-slider" type="range" min="0.1" max="1" step="0.01" value="0.92" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="bg-color" class="block text-sm font-medium text-slate-700">Background (for JPEG/WEBP)</label>
                                    <input id="bg-color" type="color" value="#ffffff" class="mt-1 h-10 w-full rounded border border-slate-300">
                                </div>
                                <div>
                                    <label for="fit-mode" class="block text-sm font-medium text-slate-700">Resize Mode</label>
                                    <select id="fit-mode" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                        <option value="exact">Exact</option>
                                        <option value="fit">Fit (contain)</option>
                                        <option value="fill">Fill (cover)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </details>

                    <div class="flex gap-2">
                        <button id="reset-btn" type="button" class="w-1/3 bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-md hover:bg-slate-300 transition">Reset</button>
                        <button id="resize-btn" class="flex-1 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200 transform hover:scale-105">
                            Resize Image
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Column: Image Previews -->
            <div class="flex flex-col space-y-6">
                <!-- Original Image Preview -->
                <div>
                    <h3 class="font-semibold text-lg text-slate-800 mb-2">Original</h3>
                    <div id="original-image-container" class="w-full aspect-square sm:aspect-video bg-slate-100 rounded-lg flex items-center justify-center border-2 border-dashed transition-all duration-300 max-h-64 sm:max-h-80 md:max-h-[28rem] overflow-hidden">
                        <p class="text-slate-500">No image selected</p>
                    </div>
                    <div id="original-details" class="text-sm text-center md:text-left text-slate-600 mt-2"></div>
                </div>

                <!-- Resized Image Preview -->
                <div>
                    <h3 class="font-semibold text-lg text-slate-800 mb-2">Resized</h3>
                    <div id="resized-image-container" class="w-full aspect-square sm:aspect-video bg-slate-100 rounded-lg flex items-center justify-center border-2 border-dashed transition-all duration-300 max-h-64 sm:max-h-80 md:max-h-[28rem] overflow-hidden">
                         <p class="text-slate-500">Waiting for resize</p>
                    </div>
                    <!-- FIX: Wrapper for details and download button to ensure correct layout -->
                    <div class="mt-2">
                        <div id="resized-details" class="text-sm text-center md:text-left text-slate-600"></div>
                        <a id="download-btn" href="#" class="hidden w-full mt-2 bg-green-600 text-white text-center font-semibold py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all duration-200 transform hover:scale-105">
                            Download Resized Image
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- History Section -->
    <div class="w-full max-w-4xl mt-6 mx-auto bg-white rounded-xl shadow p-4">
        <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold">History</h3>
            <div class="flex gap-2">
                <button id="export-history" class="px-3 py-1 text-sm rounded bg-slate-200 hover:bg-slate-300">Export</button>
                <button id="clear-history" class="px-3 py-1 text-sm rounded bg-red-100 text-red-700 hover:bg-red-200">Clear</button>
            </div>
        </div>
        <p class="text-sm text-slate-500 mb-3">Last 20 items. Stores a small preview and settings (not the full image) to keep storage light.</p>
        <div id="history-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </div>

    <!-- Custom Modal -->
    <div id="modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div id="modal-content" class="modal-content bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center opacity-0 transform scale-95">
            <p id="modal-message" class="text-slate-700 mb-4">This is a message.</p>
            <button id="modal-close-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-200">
                OK
            </button>
        </div>
    </div>

    <!-- Canvas for processing, hidden from view -->
    <canvas id="canvas" class="hidden"></canvas>

    <script>
        // DOM element references
        const fileInput = document.getElementById('file-upload');
        const fileUploadLabel = document.getElementById('file-upload-label');
        const controls = document.getElementById('controls');
        const widthInput = document.getElementById('width-input');
        const heightInput = document.getElementById('height-input');
        const aspectRatioCheckbox = document.getElementById('aspect-ratio-checkbox');
        const formatSelect = document.getElementById('format-select');
        const qualityControl = document.getElementById('quality-control');
        const qualitySlider = document.getElementById('quality-slider');
        const qualityValue = document.getElementById('quality-value');
        const scaleSlider = document.getElementById('scale-slider');
        const scaleValue = document.getElementById('scale-value');
        const presetButtons = document.getElementById('preset-buttons');
        const bgColorInput = document.getElementById('bg-color');
        const fitModeSelect = document.getElementById('fit-mode');
        const resetBtn = document.getElementById('reset-btn');
        const resizeBtn = document.getElementById('resize-btn');
        const downloadBtn = document.getElementById('download-btn');
        const originalImageContainer = document.getElementById('original-image-container');
        const resizedImageContainer = document.getElementById('resized-image-container');
        const originalDetails = document.getElementById('original-details');
        const resizedDetails = document.getElementById('resized-details');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const modal = document.getElementById('modal');
        const historyList = document.getElementById('history-list');
        const exportHistoryBtn = document.getElementById('export-history');
        const clearHistoryBtn = document.getElementById('clear-history');
        const modalContent = document.getElementById('modal-content');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const advancedDetails = document.getElementById('advanced-controls');

        let originalImage = null;
        let originalAspectRatio = 1;
        let originalFilename = 'resized-image.png';

        const HISTORY_KEY = 'imageResizerHistory';

        // --- Helper Functions ---

        function triggerAnimation(element, animationClass) {
            element.classList.remove(animationClass);
            void element.offsetWidth;
            element.classList.add(animationClass);
        }
        
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        // History functions
        function loadHistory() {
            try { return JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]'); } catch { return []; }
        }
        function saveHistory(list) { localStorage.setItem(HISTORY_KEY, JSON.stringify(list)); }
        async function createThumbnail(dataUrl, maxSize = 200) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const r = img.width / img.height;
                    let w = maxSize, h = Math.round(maxSize / r);
                    if (img.height > img.width) { h = maxSize; w = Math.round(maxSize * r); }
                    const c = document.createElement('canvas');
                    c.width = w; c.height = h;
                    const cx = c.getContext('2d');
                    cx.drawImage(img, 0, 0, w, h);
                    resolve(c.toDataURL('image/jpeg', 0.6));
                };
                img.src = dataUrl;
            });
        }
        function renderHistory() {
            const items = loadHistory();
            historyList.innerHTML = '';
            if (!items.length) {
                const empty = document.createElement('div');
                empty.className = 'text-sm text-slate-500';
                empty.textContent = 'No history yet. Resize an image to see it here.';
                historyList.appendChild(empty);
                return;
            }
            items.forEach((it, idx) => {
                const card = document.createElement('div');
                card.className = 'border rounded-lg p-3 flex items-start gap-3';
                card.innerHTML = `
                    <img src="${it.thumb}" alt="thumb" class="w-16 h-16 object-cover rounded border"/>
                    <div class="flex-1">
                        <div class="text-sm font-medium">${it.name} <span class="text-xs text-slate-500">${new Date(it.time).toLocaleString()}</span></div>
                        <div class="text-xs text-slate-500">${it.width}x${it.height} · ${it.format.toUpperCase()}${it.sizeBytes? ' · ' + (it.sizeHuman||'') : ''}</div>
                        <div class="mt-1 flex gap-2">
                            <button class="use-settings px-2 py-0.5 text-xs rounded bg-slate-200 hover:bg-slate-300">Use settings</button>
                            ${it.dataUrl ? '<a class="download-thumb px-2 py-0.5 text-xs rounded bg-green-600 text-white hover:bg-green-700" download="'+it.name+'" href="'+it.dataUrl+'">Download</a>' : ''}
                            <button class="remove-item px-2 py-0.5 text-xs rounded bg-red-100 text-red-700 hover:bg-red-200">Remove</button>
                        </div>
                    </div>
                `;
                card.querySelector('.use-settings').onclick = () => {
                    widthInput.value = it.width;
                    heightInput.value = it.height;
                    formatSelect.value = it.format.toUpperCase();
                    if (it.quality && formatSelect.value === 'JPEG') {
                        qualityControl.classList.remove('hidden');
                        qualitySlider.value = it.quality;
                        qualityValue.textContent = parseFloat(it.quality).toFixed(2);
                    }
                    triggerAnimation(controls, 'animate-slide-up');
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                };
                card.querySelector('.remove-item').onclick = () => {
                    const arr = loadHistory();
                    arr.splice(idx, 1); saveHistory(arr); renderHistory();
                };
                historyList.appendChild(card);
            });
        }

        // --- Modal Functions ---
        function showModal(message) {
            modalMessage.textContent = message;
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modalContent.classList.remove('opacity-0', 'scale-95');
        }

        function hideModal() {
            modal.classList.add('opacity-0');
            modalContent.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                 modal.classList.add('pointer-events-none');
            }, 300);
        }
        
        modalCloseBtn.addEventListener('click', hideModal);

        // Open/close advanced controls based on screen size for responsiveness
        function setAdvancedOpenByViewport() {
            if (!advancedDetails) return;
            if (window.matchMedia('(min-width: 768px)').matches) {
                advancedDetails.setAttribute('open', '');
            } else {
                advancedDetails.removeAttribute('open');
            }
        }
        setAdvancedOpenByViewport();
        window.addEventListener('resize', setAdvancedOpenByViewport);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) hideModal();
        });

        // --- Event Listeners ---

        // Drag and drop support
        ;['dragenter','dragover'].forEach(ev => fileUploadLabel.addEventListener(ev, (e) => { e.preventDefault(); fileUploadLabel.classList.add('bg-slate-50','border-indigo-400'); }));
        ;['dragleave','drop'].forEach(ev => fileUploadLabel.addEventListener(ev, (e) => { e.preventDefault(); fileUploadLabel.classList.remove('bg-slate-50','border-indigo-400'); }));
        fileUploadLabel.addEventListener('drop', (e) => {
            const file = e.dataTransfer.files?.[0];
            if (file) handleFile(file);
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFile(file);
        });

        function handleFile(file) {
            if (!file) return;
            if (!file.type.startsWith('image/')) {
                showModal('Please select a valid image file (PNG, JPG, etc.).');
                return;
            }

            originalFilename = file.name;
            const reader = new FileReader();

            reader.onload = (event) => {
                originalImage = new Image();
                originalImage.onload = () => {
                    originalAspectRatio = originalImage.width / originalImage.height;
                    widthInput.value = originalImage.width;
                    heightInput.value = originalImage.height;

                    originalImageContainer.innerHTML = '';
                    const imgElement = document.createElement('img');
                    imgElement.src = event.target.result;
                    imgElement.className = 'w-full h-full object-contain rounded-md animate-fade-in';
                    originalImageContainer.appendChild(imgElement);

                    originalDetails.innerHTML = `<p>${originalImage.width} x ${originalImage.height}px &nbsp;&bull;&nbsp; ${formatBytes(file.size)}</p>`;
                    triggerAnimation(originalDetails, 'animate-fade-in');

                    controls.classList.remove('hidden');
                    triggerAnimation(controls, 'animate-slide-up');
                    
                    resizedImageContainer.innerHTML = '<p class="text-slate-500">Waiting for resize</p>';
                    resizedDetails.innerHTML = '';
                    downloadBtn.classList.add('hidden');
                    fileUploadLabel.querySelector('span.font-semibold').textContent = 'Change image';
                    scaleSlider.value = 100; scaleValue.textContent = '100%';
                };
                originalImage.src = event.target.result;
            };

            reader.readAsDataURL(file);
        });
        
        widthInput.addEventListener('input', () => {
            if (aspectRatioCheckbox.checked && originalImage) {
                const newHeight = Math.round(widthInput.value / originalAspectRatio);
                heightInput.value = newHeight > 0 ? newHeight : '';
            }
        });

        heightInput.addEventListener('input', () => {
            if (aspectRatioCheckbox.checked && originalImage) {
                const newWidth = Math.round(heightInput.value * originalAspectRatio);
                widthInput.value = newWidth > 0 ? newWidth : '';
            }
        });

        formatSelect.addEventListener('change', () => {
            if (formatSelect.value === 'JPEG') {
                qualityControl.classList.remove('hidden');
                triggerAnimation(qualityControl, 'animate-fade-in');
            } else {
                qualityControl.classList.add('hidden');
            }
        });

        qualitySlider.addEventListener('input', () => {
            qualityValue.textContent = parseFloat(qualitySlider.value).toFixed(2);
        });

        // Presets
        presetButtons.addEventListener('click', (e) => {
            const btn = e.target.closest('button[data-size]');
            if (!btn || !originalImage) return;
            const size = parseInt(btn.getAttribute('data-size'));
            if (originalImage.width >= originalImage.height) {
                widthInput.value = size;
                heightInput.value = aspectRatioCheckbox.checked ? Math.round(size / originalAspectRatio) : heightInput.value;
            } else {
                heightInput.value = size;
                widthInput.value = aspectRatioCheckbox.checked ? Math.round(size * originalAspectRatio) : widthInput.value;
            }
            const scale = Math.round((parseInt(widthInput.value) / originalImage.width) * 100);
            scaleSlider.value = Math.max(10, Math.min(300, scale));
            scaleValue.textContent = `${scaleSlider.value}%`;
        });

        // Scale slider
        scaleSlider.addEventListener('input', () => {
            if (!originalImage) return;
            const pct = parseInt(scaleSlider.value);
            scaleValue.textContent = `${pct}%`;
            widthInput.value = Math.max(1, Math.round(originalImage.width * (pct / 100)));
            heightInput.value = aspectRatioCheckbox.checked ? Math.max(1, Math.round(widthInput.value / originalAspectRatio)) : heightInput.value;
        });

        resetBtn.addEventListener('click', () => {
            if (!originalImage) return;
            widthInput.value = originalImage.width;
            heightInput.value = originalImage.height;
            scaleSlider.value = 100; scaleValue.textContent = '100%';
            aspectRatioCheckbox.checked = true;
            formatSelect.value = 'PNG';
            qualityControl.classList.add('hidden');
            fitModeSelect.value = 'exact';
        });

        resizeBtn.addEventListener('click', async () => {
            if (!originalImage) {
                showModal('Please upload an image first.');
                return;
            }

            const width = parseInt(widthInput.value);
            const height = parseInt(heightInput.value);

            if (isNaN(width) || isNaN(height) || width <= 0 || height <= 0) {
                showModal('Please enter valid width and height.');
                return;
            }

            // Compute drawing dimensions based on fit mode
            canvas.width = width;
            canvas.height = height;
            ctx.clearRect(0,0,width,height);

            const format = formatSelect.value.toLowerCase();
            const quality = parseFloat(qualitySlider.value);
            const mimeType = `image/${format}`;
            
            // Fill background if exporting to lossy without alpha
            if (format === 'jpeg' || format === 'webp') {
                ctx.fillStyle = bgColorInput.value || '#ffffff';
                ctx.fillRect(0,0,width,height);
            }

            const mode = fitModeSelect.value;
            let sx = 0, sy = 0, sWidth = originalImage.width, sHeight = originalImage.height;
            let dx = 0, dy = 0, dWidth = width, dHeight = height;
            const srcRatio = originalImage.width / originalImage.height;
            const dstRatio = width / height;

            if (mode === 'fit') { // contain
                if (srcRatio > dstRatio) {
                    dHeight = Math.round(width / srcRatio);
                    dy = Math.round((height - dHeight) / 2);
                } else {
                    dWidth = Math.round(height * srcRatio);
                    dx = Math.round((width - dWidth) / 2);
                }
            } else if (mode === 'fill') { // cover
                if (srcRatio > dstRatio) {
                    sWidth = Math.round(originalImage.height * dstRatio);
                    sx = Math.round((originalImage.width - sWidth) / 2);
                } else {
                    sHeight = Math.round(originalImage.width / dstRatio);
                    sy = Math.round((originalImage.height - sHeight) / 2);
                }
            }

            ctx.imageSmoothingQuality = 'high';
            ctx.drawImage(originalImage, sx, sy, sWidth, sHeight, dx, dy, dWidth, dHeight);

            const resizedImageDataUrl = (format === 'jpeg' || format === 'webp')
                ? canvas.toDataURL(mimeType, quality)
                : canvas.toDataURL(mimeType);

            resizedImageContainer.innerHTML = '';
            const resizedImgElement = document.createElement('img');
            resizedImgElement.src = resizedImageDataUrl;
            resizedImgElement.className = 'w-full h-full object-contain rounded-md animate-fade-in';
            resizedImageContainer.appendChild(resizedImgElement);
            
            const head = `data:${mimeType};base64,`;
            const imageSizeInBytes = Math.round((resizedImageDataUrl.length - head.length) * 3 / 4);
            resizedDetails.innerHTML = `<p>${width} x ${height}px &nbsp;&bull;&nbsp; Est. ${formatBytes(imageSizeInBytes)}</p>`;
            triggerAnimation(resizedDetails, 'animate-fade-in');

            const fileExtension = format === 'jpeg' ? 'jpg' : (format === 'webp' ? 'webp' : 'png');
            const newFilename = originalFilename.replace(/\.[^/.]+$/, "") + `.${fileExtension}`;
            
            downloadBtn.href = resizedImageDataUrl;
            downloadBtn.download = `resized-${newFilename}`;
            downloadBtn.classList.remove('hidden');
            triggerAnimation(downloadBtn, 'animate-slide-up');

            // History entry (store small preview + settings, optionally dataUrl if small)
            const thumb = await createThumbnail(resizedImageDataUrl, 160);
            const entry = {
                time: Date.now(),
                name: `resized-${newFilename}`,
                width, height,
                format,
                quality: (format === 'jpeg' || format === 'webp') ? quality : undefined,
                sizeBytes: imageSizeInBytes,
                sizeHuman: formatBytes(imageSizeInBytes),
                thumb,
            };
            // Store dataUrl only if small to avoid exceeding localStorage limits
            if (resizedImageDataUrl.length < 450000) entry.dataUrl = resizedImageDataUrl;
            const list = loadHistory();
            list.unshift(entry);
            while (list.length > 20) list.pop();
            saveHistory(list);
            renderHistory();
        });

        exportHistoryBtn.addEventListener('click', () => {
            const data = JSON.stringify(loadHistory(), null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'image-resizer-history.json'; a.click();
            URL.revokeObjectURL(url);
        });
        clearHistoryBtn.addEventListener('click', () => { saveHistory([]); renderHistory(); });

        // Initial render
        renderHistory();
    </script>
</body>
</html>
