<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced AI Meeting Notes Formatter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/diff_match_patch/20121119/diff_match_patch.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loader {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4f46e5;
            animation: spin 1s linear infinite;
        }
        .tab-active {
            border-bottom-color: #4f46e5;
            color: #4f46e5;
        }
        
        /* Styling for the parsed UI preview and diffs */
        .prose-preview {
            max-width: none;
            color: #334155;
            line-height: 1.65;
        }
        .prose-preview h3 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e2e8f0;
            color: #1e293b;
        }
        .prose-preview strong {
            font-weight: 600;
            color: #1e293b;
        }
        .prose-preview ul, .prose-preview ol {
            padding-left: 1.5em;
            margin: 1em 0;
        }
        .prose-preview li {
            margin-top: 0.5em;
        }
        .prose-preview ins {
            background-color: #dcfce7; /* green-100 */
            text-decoration: none;
        }
        .prose-preview del {
            background-color: #fee2e2; /* red-100 */
            text-decoration: line-through;
            color: #ef4444; /* red-500 */
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-6 md:p-8">
        
        <div class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Advanced AI Meeting Notes Formatter</h1>
            <p class="text-slate-500 mt-2">Generate, preview, refine, and see changes highlighted.</p>
        </div>

        <div>
            <label for="raw-notes" class="block text-sm font-medium text-slate-700 mb-2">Your Raw Notes</label>
            <textarea id="raw-notes" rows="10" class="w-full p-4 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out" placeholder="e.g., 'Okay everyone, let's start. John, can you talk about the Q3 marketing campaign? Jane mentioned we need to finalize the budget by Friday. The main goal is to increase leads by 20%.'"></textarea>
        </div>

        <div class="mt-6 text-center">
            <button id="generate-btn" class="bg-indigo-600 text-white font-semibold py-3 px-8 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">
                Generate Initial Notes
            </button>
        </div>

        <div id="loader" class="hidden flex justify-center items-center my-8">
            <div class="loader w-12 h-12 rounded-full"></div>
            <p class="ml-4 text-slate-600">AI is thinking...</p>
        </div>

        <!-- History Container -->
        <div id="notes-history" class="mt-8 space-y-6"></div>

        <!-- Message Box for notifications -->
        <div id="message-box" class="hidden fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg transition-opacity duration-300">
            Copied to clipboard!
        </div>

    </div>

    <script>
        const rawNotesTextarea = document.getElementById('raw-notes');
        const generateBtn = document.getElementById('generate-btn');
        const loader = document.getElementById('loader');
        const notesHistoryContainer = document.getElementById('notes-history');
        const messageBox = document.getElementById('message-box');
        
        const markdownConverter = new showdown.Converter({
            ghCompatibleHeaderId: true,
            simpleLineBreaks: true,
            ghMentions: true,
            tables: true
        });
        const dmp = new diff_match_patch();

        let conversationHistory = [];
        let lastMarkdownText = ""; // Store the most recent markdown for diffing

        async function callGemini(history) {
            const apiKey = "AIzaSyD_hF3zYDCo4UoGn-LPdqa0nL9lbG3v4nA"; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = { contents: history };
            let retries = 3, delay = 1000;
            while (retries > 0) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const result = await response.json();
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        let errorMessage = "The model returned an empty response. Please try refining your input.";
                        if (result.promptFeedback?.blockReason) {
                            errorMessage = `Request blocked. Reason: ${result.promptFeedback.blockReason}. Please adjust your input.`;
                        }
                        throw new Error(errorMessage);
                    }
                } catch (error) {
                    console.error("API call failed:", error);
                    retries--;
                    if (retries === 0) throw error;
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2;
                }
            }
        }

        function createNoteCard(markdownText, historyForThisCard, previousMarkdown = "") {
            const cardId = `card-${Date.now()}`;
            const card = document.createElement('div');
            card.className = 'bg-slate-50 p-4 rounded-lg border border-slate-200 shadow-sm';
            card.id = cardId;

            let htmlContent;
            if (previousMarkdown) {
                const diffs = dmp.diff_main(previousMarkdown, markdownText);
                dmp.diff_cleanupSemantic(diffs);
                htmlContent = dmp.diff_prettyHtml(diffs);
            } else {
                htmlContent = markdownConverter.makeHtml(markdownText);
            }
            
            // The diff library doesn't parse markdown, so we do it after creating the diff.
            htmlContent = markdownConverter.makeHtml(htmlContent);

            card.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                    <div class="border-b border-slate-200">
                        <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                            <button class="tab-btn whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm" data-tab="preview">Preview</button>
                            <button class="tab-btn whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm" data-tab="markdown">Markdown</button>
                        </nav>
                    </div>
                    <button class="copy-btn bg-slate-200 text-slate-700 font-medium py-1.5 px-3 rounded-lg text-sm hover:bg-slate-300">Copy</button>
                </div>

                <div class="tab-content" data-tab-content="preview">
                    <div class="prose-preview p-3 bg-white rounded-md border border-slate-200">${htmlContent}</div>
                </div>
                <div class="tab-content" data-tab-content="markdown">
                    <pre class="whitespace-pre-wrap text-sm text-slate-700 bg-white p-3 rounded-md max-h-80 overflow-y-auto">${markdownText}</pre>
                </div>

                <div class="mt-4 pt-4 border-t border-slate-200">
                    <label class="block text-sm font-medium text-slate-600 mb-1">Missing something? Add details to refine.</label>
                    <div class="flex space-x-2">
                        <input type="text" class="refine-input w-full p-2 border border-slate-300 rounded-md text-sm" placeholder="e.g., 'The meeting was on Aug 7, 2025. Bob is the owner of the design task.'">
                        <button class="refine-btn bg-indigo-500 text-white font-semibold py-2 px-4 rounded-md text-sm hover:bg-indigo-600">Refine</button>
                    </div>
                </div>
            `;

            notesHistoryContainer.prepend(card);

            const currentCard = document.getElementById(cardId);
            const tabButtons = currentCard.querySelectorAll('.tab-btn');
            const tabContents = currentCard.querySelectorAll('.tab-content');

            // Function to activate a tab
            const activateTab = (tabName) => {
                tabButtons.forEach(btn => {
                    btn.classList.remove('tab-active');
                    btn.classList.add('text-slate-500', 'hover:text-slate-700', 'hover:border-slate-300');
                });
                const activeButton = currentCard.querySelector(`[data-tab="${tabName}"]`);
                activeButton.classList.add('tab-active');
                activeButton.classList.remove('text-slate-500', 'hover:text-slate-700', 'hover:border-slate-300');
                
                tabContents.forEach(content => content.classList.add('hidden'));
                currentCard.querySelector(`[data-tab-content="${tabName}"]`).classList.remove('hidden');
            };

            // Default to showing Preview tab first
            activateTab('preview');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => activateTab(button.dataset.tab));
            });
            
            currentCard.querySelector('.copy-btn').addEventListener('click', () => {
                navigator.clipboard.writeText(markdownText).then(() => {
                    messageBox.classList.remove('hidden');
                    setTimeout(() => messageBox.classList.add('hidden'), 2000);
                }).catch(err => console.error('Copy failed', err));
            });

            currentCard.querySelector('.refine-btn').addEventListener('click', () => {
                const refinementText = currentCard.querySelector('.refine-input').value.trim();
                if (refinementText) {
                    handleGeneration(true, refinementText, historyForThisCard, markdownText);
                }
            });
        }

        async function handleGeneration(isRefinement = false, refinementText = '', existingHistory = [], previousMarkdown = "") {
            let currentHistory = [];
            let prompt;

            if (isRefinement) {
                currentHistory = [...existingHistory];
                prompt = `Based on our previous conversation, please regenerate the entire meeting notes summary, incorporating this new information: "${refinementText}". It is crucial that you output the **complete, updated summary** and maintain the original Markdown structure (Title, Date, Attendees, etc.).`;
                currentHistory.push({ role: "user", parts: [{ text: prompt }] });
            } else {
                const notes = rawNotesTextarea.value.trim();
                if (!notes) { alert("Please enter some notes first."); return; }
                
                const now = new Date();
                const tenMinutesAgo = new Date(now.getTime() - 10 * 60 * 1000);
                const defaultDate = now.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                const defaultTime = tenMinutesAgo.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                
                // --- REVERTED TO THE MORE DETAILED PROMPT ---
                prompt = `You are an expert meeting assistant. Your task is to take the following raw, unstructured meeting conversation notes and transform them into a clean, well-organized summary in Markdown format.

The output MUST follow this structure:

### Meeting Title
*Infer a concise title from the notes.*

**Date & Time:** *Identify the date and time from the notes. If not mentioned, default to today's date, which is **${defaultDate}**, and assume the meeting ended around **${defaultTime}** (about 10 minutes ago).*

**Attendees:**
*List all participants mentioned by name.*
- Name 1
- Name 2

**Discussion Summary:**
*Concisely summarize the key points, conversations, and arguments.*
- Key point discussed...
- Another key point...

**Action Items:**
*List all clear tasks assigned to individuals. Use a checkbox format.*
- [ ] @Owner - Task description (Due: YYYY-MM-DD if specified)

**Decisions Made:**
*List any final decisions that were agreed upon.*
- Decision 1...

Analyze the text to identify all the required information. If a section has no relevant information, you can state "None" or omit the section. Be concise and professional.

Here are the raw notes:
---
${notes}`;
                
                conversationHistory = [{ role: "user", parts: [{ text: prompt }] }];
                currentHistory = conversationHistory;
            }

            loader.classList.remove('hidden');
            generateBtn.disabled = true;
            document.querySelectorAll('.refine-btn').forEach(b => b.disabled = true);

            try {
                const formattedNotes = await callGemini(currentHistory);
                currentHistory.push({ role: "model", parts: [{ text: formattedNotes }] });
                
                if (!isRefinement) {
                    conversationHistory = currentHistory;
                }
                
                createNoteCard(formattedNotes, currentHistory, previousMarkdown);
                lastMarkdownText = formattedNotes; // Update the last version

            } catch (error) {
                alert(`An error occurred: ${error.message}`);
            } finally {
                loader.classList.add('hidden');
                generateBtn.disabled = false;
                document.querySelectorAll('.refine-btn').forEach(b => b.disabled = false);
            }
        }

        generateBtn.addEventListener('click', () => handleGeneration(false));

    </script>
</body>
</html>
